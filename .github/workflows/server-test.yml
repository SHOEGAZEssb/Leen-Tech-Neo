name: Packwiz smoke test (server boot)

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

jobs:
  smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java (17)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Go (for packwiz)
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"

      - name: Install packwiz
        shell: bash
        run: |
          set -euo pipefail
          go install github.com/packwiz/packwiz@latest
          echo "$(go env GOPATH)/bin" >> "$GITHUB_PATH"

      - name: Cache packwiz downloads
        uses: actions/cache@v4
        with:
          path: ~/.cache/packwiz
          key: packwiz-cache-${{ runner.os }}-${{ hashFiles('**/pack.toml', '**/index.toml', '**/*.pw.toml') }}
          restore-keys: |
            packwiz-cache-${{ runner.os }}-

      - name: Refresh pack index
        run: packwiz refresh

      - name: Install Forge server (1.20.1 / 47.4.16)
        shell: bash
        run: |
          set -euo pipefail

          MC="1.20.1"
          FORGE="47.4.16"

          mkdir -p server
          cd server

          curl -fL -o forge-installer.jar \
            "https://maven.minecraftforge.net/net/minecraftforge/forge/${MC}-${FORGE}/forge-${MC}-${FORGE}-installer.jar"

          java -jar forge-installer.jar --installServer
          echo "eula=true" > eula.txt

      - name: Download server-side mods (with CF patch fallback)
        shell: bash
        run: |
          set -euo pipefail

          curl -fL -o packwiz-installer-bootstrap.jar \
            "https://github.com/packwiz/packwiz-installer-bootstrap/releases/latest/download/packwiz-installer-bootstrap.jar"

          packwiz serve --port 8080 > /tmp/packwiz-serve.log 2>&1 &
          SERVE_PID=$!

          cleanup() {
            kill "$SERVE_PID" >/dev/null 2>&1 || true
          }
          trap cleanup EXIT

          # wait until serve is reachable
          for i in {1..30}; do
            if curl -fsS "http://127.0.0.1:8080/pack.toml" >/dev/null 2>&1; then
              break
            fi
            sleep 1
          done

          cd server

          # first attempt
          set +e
          java -jar ../packwiz-installer-bootstrap.jar -g -s server \
            "http://127.0.0.1:8080/pack.toml" 2>&1 | tee /tmp/installer.log
          code=${PIPESTATUS[0]}
          set -e

          if grep -q "excluded from the CurseForge API" /tmp/installer.log; then
            echo ""
            echo "CurseForge API-blocked mods detected. Patching them to client-side for CI..."

            # extract jar filenames from installer output
            grep -Eo '/mods/[^ ]+\.jar' /tmp/installer.log | \
              sed 's#.*/mods/##' | sort -u > /tmp/blocked-jars.txt

            while read -r jar; do
              pwfile=$(grep -Rl "filename = \"$jar\"" ../mods || true)
              if [ -n "$pwfile" ]; then
                echo "Patching $pwfile"
                sed -i 's/^side = "both"/side = "client"/' "$pwfile"
              else
                echo "Could not find .pw.toml for $jar"
              fi
            done < /tmp/blocked-jars.txt

            echo "Re-running installer after patch..."
            java -jar ../packwiz-installer-bootstrap.jar -g -s server \
              "http://127.0.0.1:8080/pack.toml"
          else
            exit "$code"
          fi

      - name: Boot server (smoke test)
        shell: bash
        run: |
          set -euo pipefail
          cd server

          if [ -f "./run.sh" ]; then
            chmod +x ./run.sh
            BOOT_CMD=(./run.sh nogui)
          else
            JAR="$(ls -1 forge-*-server.jar 2>/dev/null | head -n 1 || true)"
            BOOT_CMD=(java -Xmx4G -jar "$JAR" nogui)
          fi

          rm -f server.log server.stdin
          mkfifo server.stdin

          (stdbuf -oL -eL "${BOOT_CMD[@]}" < server.stdin) > server.log 2>&1 &
          SERVER_PID=$!

          cleanup() {
            if kill -0 "$SERVER_PID" >/dev/null 2>&1; then
              echo "stop" > server.stdin || true
              sleep 3
              kill "$SERVER_PID" >/dev/null 2>&1 || true
            fi
            rm -f server.stdin
          }
          trap cleanup EXIT

          deadline=$((SECONDS + 240))

          while [ "$SECONDS" -lt "$deadline" ]; do
            if grep -E "Crash report saved to|Exception in thread|-- System Details --|A fatal error has been detected" server.log >/dev/null 2>&1; then
              echo "Crash markers detected."
              exit 1
            fi

            if grep -E "DedicatedServer\]: Done \\(" server.log >/dev/null 2>&1; then
              echo "Server reached DONE â€” stopping."
              echo "stop" > server.stdin
              sleep 5
              exit 0
            fi

            sleep 2
          done

          echo "Server did not reach DONE within timeout."
          tail -n 200 server.log || true
          exit 1

      - name: Upload server log on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: server-log
          path: server/server.log
