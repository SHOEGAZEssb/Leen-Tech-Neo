name: Packwiz smoke test (server boot)

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

jobs:
  smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java (17)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Go (for packwiz)
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"

      - name: Install packwiz
        shell: bash
        run: |
          set -euo pipefail

          go install github.com/packwiz/packwiz@latest
          echo "$(go env GOPATH)/bin" >> "$GITHUB_PATH"

      - name: Cache packwiz downloads
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/packwiz
          key: packwiz-cache-${{ runner.os }}-${{ hashFiles('**/pack.toml', '**/index.toml', '**/*.pw.toml') }}
          restore-keys: |
            packwiz-cache-${{ runner.os }}-

      - name: Refresh pack index
        shell: bash
        run: |
          set -euo pipefail
          packwiz refresh

      - name: Install Forge server (1.20.1 / 47.4.16)
        shell: bash
        run: |
          set -euo pipefail

          MC="1.20.1"
          FORGE="47.4.16"

          mkdir -p server
          cd server

          FORGE_INSTALLER="forge-${MC}-${FORGE}-installer.jar"
          FORGE_URL="https://maven.minecraftforge.net/net/minecraftforge/forge/${MC}-${FORGE}/${FORGE_INSTALLER}"

          curl -fL -o "$FORGE_INSTALLER" "$FORGE_URL"
          java -jar "$FORGE_INSTALLER" --installServer

          echo "eula=true" > eula.txt

      - name: Download server-side mods with packwiz-installer
        shell: bash
        run: |
          set -euo pipefail

          curl -fL -o packwiz-installer-bootstrap.jar \
            "https://github.com/packwiz/packwiz-installer-bootstrap/releases/latest/download/packwiz-installer-bootstrap.jar"

          # serve the pack locally so packwiz-installer can fetch pack.toml/index.toml/mods
          packwiz serve --port 8080 --bind 127.0.0.1 >/tmp/packwiz-serve.log 2>&1 &
          SERVE_PID=$!

          cleanup() {
            kill "$SERVE_PID" >/dev/null 2>&1 || true
          }
          trap cleanup EXIT

          cd server

          # -g: no GUI, -s server: only server/both mods
          java -jar ../packwiz-installer-bootstrap.jar -g -s server "http://127.0.0.1:8080/pack.toml"

          echo "Installed mods:"
          ls -la mods || true

      - name: Boot server (smoke test)
        shell: bash
        run: |
          set -euo pipefail
          cd server

          if [ -f "./run.sh" ]; then
            chmod +x ./run.sh
            BOOT_CMD=(./run.sh nogui)
          else
            JAR="$(ls -1 forge-*-server.jar 2>/dev/null | head -n 1 || true)"
            if [ -z "$JAR" ]; then
              echo "Couldn't find run.sh or forge-*-server.jar. Listing server dir:"
              ls -la
              exit 1
            fi
            BOOT_CMD=(java -Xmx4G -jar "$JAR" nogui)
          fi

          rm -f server.log server.stdin
          mkfifo server.stdin

          (stdbuf -oL -eL "${BOOT_CMD[@]}" < server.stdin) > server.log 2>&1 &
          SERVER_PID=$!

          cleanup() {
            if kill -0 "$SERVER_PID" >/dev/null 2>&1; then
              echo "stop" > server.stdin || true
              sleep 3
              kill "$SERVER_PID" >/dev/null 2>&1 || true
            fi
            rm -f server.stdin
          }
          trap cleanup EXIT

          deadline=$((SECONDS + 240))

          while [ "$SECONDS" -lt "$deadline" ]; do
            if grep -E "Crash report saved to|Exception in thread|-- System Details --|A fatal error has been detected" -n server.log >/dev/null 2>&1; then
              echo "Crash markers detected."
              exit 1
            fi

            if grep -E "DedicatedServer\]: Done \\(" -n server.log >/dev/null 2>&1; then
              echo "Server reached DONE â€” stopping server."
              echo "stop" > server.stdin

              for _ in {1..30}; do
                kill -0 "$SERVER_PID" >/dev/null 2>&1 || exit 0
                sleep 1
              done

              echo "Server did not exit after stop; killing."
              exit 0
            fi

            sleep 2
          done

          echo "Server did not reach DONE within timeout."
          exit 1

      - name: Upload server log on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: server-log
          path: server/server.log
