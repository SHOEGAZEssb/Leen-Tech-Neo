name: Packwiz smoke test (server boot)

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

jobs:
  smoke:
    runs-on: ubuntu-latest

    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Java 17 is correct for Forge 1.20.1
      - name: Setup Java (17)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      # Install Go so we can build packwiz properly
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"

      - name: Install packwiz
        shell: bash
        run: |
          set -euo pipefail

          # reproducible version (you can pin a commit if you want)
          go install github.com/packwiz/packwiz@latest

          echo "$(go env GOPATH)/bin" >> "$GITHUB_PATH"

      - name: Cache packwiz downloads
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/packwiz
          key: packwiz-cache-${{ runner.os }}-${{ hashFiles('**/pack.toml', '**/index.toml', '**/*.pw.toml') }}
          restore-keys: |
            packwiz-cache-${{ runner.os }}-

      - name: Refresh pack index
        run: packwiz refresh

      - name: Export server pack (CurseForge format)
        run: |
          set -euo pipefail
          rm -f server-pack.zip
          packwiz curseforge export -s server -o server-pack.zip
          ls -lah server-pack.zip

      - name: Read Minecraft & Forge versions from pack.toml
        shell: bash
        run: |
          set -euo pipefail

          python3 - <<'PY'
          import tomllib, pathlib

          data = tomllib.loads(pathlib.Path("pack.toml").read_text(encoding="utf-8"))
          v = data.get("versions", {})
          mc = v.get("minecraft")
          forge = v.get("forge")

          if not mc or not forge:
              raise SystemExit(f"pack.toml missing versions.minecraft or versions.forge: {v}")

          pathlib.Path("ci_versions.env").write_text(
              f"MC={mc}\nFORGE={forge}\n",
              encoding="utf-8"
          )

          print(f"Using Minecraft {mc}, Forge {forge}")
          PY

      - name: Install Forge server
        shell: bash
        run: |
          set -euo pipefail

          source ci_versions.env

          mkdir server
          cd server

          FORGE_INSTALLER="forge-${MC}-${FORGE}-installer.jar"
          FORGE_URL="https://maven.minecraftforge.net/net/minecraftforge/forge/${MC}-${FORGE}/${FORGE_INSTALLER}"

          echo "Downloading $FORGE_URL"
          curl -fL -o "$FORGE_INSTALLER" "$FORGE_URL"

          java -jar "$FORGE_INSTALLER" --installServer

          echo "eula=true" > eula.txt

          cd ..

      - name: Inject pack files into server
        shell: bash
        run: |
          set -euo pipefail

          unzip -o server-pack.zip -d exported

          # CF export structure: manifest.json + overrides/
          if [ -d exported/overrides ]; then
            rsync -a exported/overrides/ server/
          else
            echo "No overrides folder found"
          fi

      - name: Boot server (smoke test)
        shell: bash
        run: |
          set -euo pipefail
          cd server

          # Prefer run.sh if present
          if [ -f "./run.sh" ]; then
            chmod +x ./run.sh
            BOOT_CMD=(./run.sh nogui)
          else
            JAR="$(ls -1 forge-*-server.jar 2>/dev/null | head -n 1 || true)"
            if [ -z "$JAR" ]; then
              echo "No run.sh or forge server jar found:"
              ls -la
              exit 1
            fi
            BOOT_CMD=(java -Xmx4G -jar "$JAR" nogui)
          fi

          echo "Starting server..."

          set +e
          timeout 240s "${BOOT_CMD[@]}" 2>&1 | tee server.log
          code=${PIPESTATUS[0]}
          set -e

          echo "Exit code: $code"

          # Crash markers
          if grep -E "Crash report saved to|Exception in thread|-- System Details --|A fatal error has been detected" -n server.log; then
            echo "Crash markers detected."
            exit 1
          fi

          # Successful startup marker
          if grep -E "Done \\(" -n server.log; then
            echo "Server reached DONE â€” smoke test passed."
            exit 0
          fi

          if [ "$code" -eq 124 ]; then
            echo "Server did not reach DONE within timeout."
            exit 1
          fi

          if [ "$code" -ne 0 ]; then
            echo "Server exited with non-zero code."
            exit 1
          fi

          echo "Server exited without reaching DONE."
          exit 1

      - name: Upload server log on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: server-log
          path: server/server.log